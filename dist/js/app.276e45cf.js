(function(){"use strict";var t={1605:function(t,e,s){var a=s(6848),r=function(){var t=this,e=t._self._c;return e("div",{attrs:{id:"app"}},[e("router-view")],1)},i=[],o={name:"App"},l=o,n=s(1656),c=(0,n.A)(l,r,i,!1,null,null,null),d=c.exports,u=(s(8111),s(3579),s(6178)),p=function(){var t=this,e=t._self._c;return e("div",{staticClass:"home-page"},[e("main-header"),e("div",{staticClass:"carousel-container"},[e("el-carousel",{attrs:{height:"calc(100vh - 60px)","indicator-position":"outside"}},t._l(t.carouselItems,function(s,a){return e("el-carousel-item",{key:a},[e("img",{staticClass:"carousel-img",attrs:{src:s.imgUrl,alt:"轮播图"}}),e("div",{staticClass:"carousel-caption"},[t._v(t._s(s.caption))])])}),1)],1)],1)},h=[],m=(s(4114),function(){var t=this,e=t._self._c;return e("header",{staticClass:"main-header"},[e("div",{staticClass:"container"},[e("div",{staticClass:"logo",on:{mouseenter:function(e){t.logoHover=!0},mouseleave:function(e){t.logoHover=!1}}},[e("i",{staticClass:"el-icon-water-tap",class:{"logo-icon-active":t.logoHover}}),e("span",{staticClass:"logo-text",class:{"logo-text-active":t.logoHover}},[t._v(" 智"),e("span",{staticClass:"logo-text-highlight"},[t._v("感")]),t._v("清"),e("span",{staticClass:"logo-text-highlight"},[t._v("浊")])])]),e("nav",{staticClass:"main-nav"},[e("ul",{staticClass:"nav-links"},[e("li",{staticClass:"nav-item"},[e("router-link",{staticClass:"nav-link",attrs:{to:"/"}},[t._v("首页")])],1),e("li",{staticClass:"nav-item"},[e("a",{staticClass:"nav-link",attrs:{href:"javascript:void(0)"},on:{click:function(e){return t.handleNavigation("/water-sources")}}},[t._v("水源管理")])]),e("li",{staticClass:"nav-item"},[e("a",{staticClass:"nav-link",attrs:{href:"javascript:void(0)"},on:{click:function(e){return t.handleNavigation("/report")}}},[t._v("我的报告")])]),e("li",{staticClass:"nav-item"},[e("a",{staticClass:"nav-link",attrs:{href:"javascript:void(0)"},on:{click:function(e){return t.handleNavigation("/devices")}}},[t._v("设备联网")])]),t.isLoggedIn?e("li",{staticClass:"nav-item"},[e("span",{staticClass:"nav-link btn login-btn",on:{click:t.showLoggedInTip}},[t._v("已登录")])]):e("li",{staticClass:"nav-item"},[e("span",{staticClass:"nav-link btn login-btn",on:{click:function(e){return t.handleNavigation("/auth")}}},[t._v(" 登录/注册 ")])]),e("li",{staticClass:"nav-item"},[e("a",{staticClass:"nav-link btn user-btn",attrs:{href:"javascript:void(0)"},on:{click:function(e){return t.handleNavigation("/user-profile")}}},[e("i",{staticClass:"el-icon-user"}),t._v(" 用户中心 ")])])])])])])}),v=[],g={data(){return{logoHover:!1}},computed:{isLoggedIn(){return!!localStorage.getItem("token")}},methods:{handleNavigation(t){this.isLoggedIn?this.$route.path!==t&&this.$router.push(t):(this.$message.warning("请先登录"),this.$router.push("/auth"))},showLoggedInTip(){this.$message.info("您已登录，无需重复登录")}}},f=g,C=(0,n.A)(f,m,v,!1,null,"218896c2",null),b=C.exports,w={components:{MainHeader:b},data(){return{carouselItems:[{imgUrl:s(8163),caption:"智慧水资源监测系统 - 精准监测每一滴水"},{imgUrl:s(2675),caption:"实时数据分析，保障用水安全"},{imgUrl:s(7163),caption:"智能设备联网，远程监控水资源状态"}]}},methods:{goToLogin(){this.$router.push("/auth")}}},y=w,_=(0,n.A)(y,p,h,!1,null,"c8f3ab10",null),S=_.exports,I=function(){var t=this,e=t._self._c;return e("div",{staticClass:"auth-container"},[e("div",{staticClass:"particles-bg",attrs:{id:"particles-js"}}),e("div",{staticClass:"glass-card"},[t._m(0),e("div",{staticClass:"card-content"},[t._m(1),e("div",{staticClass:"auth-tabs"},[e("div",{staticClass:"tabs-header"},[e("div",{staticClass:"tab-item",class:{active:"login"===t.activeTab},on:{click:function(e){t.activeTab="login"}}},[e("span",{staticClass:"tab-label"},[t._v("账户登录")])]),e("div",{staticClass:"tab-divider"},[t._v("|")]),e("div",{staticClass:"tab-item",class:{active:"register"===t.activeTab},on:{click:function(e){t.activeTab="register"}}},[e("span",{staticClass:"tab-label"},[t._v("注册账户")])])]),e("div",{staticClass:"tabs-content"},["login"===t.activeTab?e("LoginComponent",{on:{"login-success":t.handleLoginSuccess}}):t._e(),"register"===t.activeTab?e("RegisterComponent",{on:{"register-success":t.handleRegisterSuccess}}):t._e()],1)])])]),e("div",{staticClass:"water-wave"})])},R=[function(){var t=this,e=t._self._c;return e("div",{staticClass:"card-decoration"},[e("div",{staticClass:"decoration-circle circle-1"}),e("div",{staticClass:"decoration-circle circle-2"}),e("div",{staticClass:"decoration-circle circle-3"})])},function(){var t=this,e=t._self._c;return e("div",{staticClass:"system-header"},[e("div",{staticClass:"logo-container"},[e("i",{staticClass:"el-icon-water-tap logo-icon"})]),e("h1",{staticClass:"system-title"},[t._v("水资源监测系统")]),e("p",{staticClass:"system-subtitle"},[t._v("智慧水务 · 精准监测 · 安全守护")])])}],D=function(){var t=this,e=t._self._c;return e("el-form",{ref:"loginForm",attrs:{model:t.loginForm,rules:t.rules,"label-width":"80px"}},[e("el-form-item",{attrs:{label:"用户名",prop:"username"}},[e("el-input",{model:{value:t.loginForm.username,callback:function(e){t.$set(t.loginForm,"username",e)},expression:"loginForm.username"}})],1),e("el-form-item",{attrs:{label:"密码",prop:"password"}},[e("el-input",{attrs:{type:"password"},model:{value:t.loginForm.password,callback:function(e){t.$set(t.loginForm,"password",e)},expression:"loginForm.password"}})],1),e("el-form-item",[e("el-button",{attrs:{type:"primary"},on:{click:t.handleLogin}},[t._v("登录")])],1)],1)},A=[],$=s(4373),k=s(1524),T=s.n(k);$.A.defaults.baseURL="/api",$.A.interceptors.request.use(t=>{const e=localStorage.getItem("token");return e&&(t.headers.Authorization=`Bearer ${e}`),t},t=>Promise.reject(t)),$.A.interceptors.response.use(t=>t.data,t=>(t.response&&401===t.response.status?(localStorage.removeItem("token"),kt.push("/"),k.Message.error("登录已过期，请重新登录")):k.Message.error(t.response?.data?.message||"请求失败"),Promise.reject(t)));var x=$.A,F={data(){return{loginForm:{username:"",password:""},rules:{username:[{required:!0,message:"请输入用户名",trigger:"blur"}],password:[{required:!0,message:"请输入密码",trigger:"blur"}]}}},methods:{handleLogin(){this.$refs.loginForm.validate(async t=>{if(t)try{const t=await x.post("/auth/login",this.loginForm);localStorage.setItem("token",t.data),this.$emit("login-success"),this.$message.success("登录成功")}catch(e){this.$message.error("登录失败: "+(e.response?.data?.message||e.message))}})}}},P=F,E=(0,n.A)(P,D,A,!1,null,null,null),L=E.exports,N=function(){var t=this,e=t._self._c;return e("el-form",{ref:"registerForm",staticClass:"register-form",attrs:{model:t.registerForm,rules:t.rules,"label-width":"80px"}},[e("el-form-item",{attrs:{label:"用户名",prop:"username"}},[e("el-input",{model:{value:t.registerForm.username,callback:function(e){t.$set(t.registerForm,"username",e)},expression:"registerForm.username"}})],1),e("el-form-item",{attrs:{label:"密码",prop:"password"}},[e("el-input",{attrs:{type:"password"},model:{value:t.registerForm.password,callback:function(e){t.$set(t.registerForm,"password",e)},expression:"registerForm.password"}})],1),e("el-form-item",[e("el-button",{attrs:{type:"primary"},on:{click:t.handleRegister}},[t._v("注册")])],1)],1)},M=[],W={data(){return{registerForm:{username:"",password:""},rules:{username:[{required:!0,message:"请输入用户名",trigger:"blur"}],password:[{required:!0,message:"请输入密码",trigger:"blur"}]}}},methods:{handleRegister(){this.$refs.registerForm.validate(async t=>{if(t)try{await x.post("/auth/register",this.registerForm),this.$emit("register-success")}catch(e){this.$message.error("注册失败: "+(e.response?.data?.message||e.message))}})}}},U=W,V=(0,n.A)(U,N,M,!1,null,"25fd6ac0",null),q=V.exports,H={components:{LoginComponent:L,RegisterComponent:q},data(){return{activeTab:"login"}},mounted(){this.initParticles();const t=this.$route.query.type;"register"===t&&(this.activeTab="register")},methods:{handleLoginSuccess(){document.querySelector(".glass-card").classList.add("success-animation"),setTimeout(()=>{this.$router.push("/")},800)},handleRegisterSuccess(){this.activeTab="login",this.$message.success("注册成功，请登录您的账户")},initParticles(){if("undefined"!==typeof window){const t=document.createElement("canvas"),e=t.getContext("2d"),s=document.getElementById("particles-js");s&&e&&(s.appendChild(t),this.setupParticles(t,e))}},setupParticles(t,e){const s=()=>{t.width=window.innerWidth,t.height=window.innerHeight};s(),window.addEventListener("resize",s);const a=[],r=30;for(let o=0;o<r;o++)a.push({x:Math.random()*t.width,y:Math.random()*t.height,size:3*Math.random()+1,speedX:1*Math.random()-.5,speedY:1*Math.random()-.5,opacity:.5*Math.random()+.2});const i=()=>{e.clearRect(0,0,t.width,t.height),a.forEach(s=>{s.x+=s.speedX,s.y+=s.speedY,(s.x<0||s.x>t.width)&&(s.speedX*=-1),(s.y<0||s.y>t.height)&&(s.speedY*=-1),e.beginPath(),e.arc(s.x,s.y,s.size,0,2*Math.PI),e.fillStyle=`rgba(255, 255, 255, ${s.opacity})`,e.fill()}),requestAnimationFrame(i)};i()}}},O=H,z=(0,n.A)(O,I,R,!1,null,"4806a6ab",null),G=z.exports,j=function(){var t=this,e=t._self._c;return e("div",{staticClass:"water-source-container"},[e("MainHeader"),e("div",{staticClass:"bg-decoration"}),e("div",{staticClass:"content-wrapper"},[e("div",{staticClass:"header-section"},[t._m(0),e("div",{staticClass:"feature-cards-horizontal"},[e("div",{staticClass:"feature-card",on:{click:t.handleAdd}},[t._m(1),t._m(2),t._m(3)])])]),e("div",{staticClass:"main-content"},[e("div",{staticClass:"toolbar-section"},[e("div",{staticClass:"search-box"},[e("el-input",{staticClass:"search-input",attrs:{placeholder:"按水源ID或名称搜索...","prefix-icon":"el-icon-search",clearable:""},on:{clear:t.handleSearchClear,keyup:function(e){return!e.type.indexOf("key")&&t._k(e.keyCode,"enter",13,e.key,"Enter")?null:t.handleSearchById.apply(null,arguments)}},model:{value:t.searchId,callback:function(e){t.searchId=e},expression:"searchId"}}),e("el-button",{staticClass:"search-btn",attrs:{type:"primary",loading:t.searchLoading},on:{click:t.handleSearchById}},[t._v(" 搜索 ")])],1)]),e("div",{staticClass:"table-section"},[e("el-card",{staticClass:"table-card",attrs:{shadow:"never"}},[e("div",{staticClass:"table-header"},[e("h3",{staticClass:"table-title"},[t._v("监测点列表")]),t.isSearching?e("div",{staticClass:"search-status"},[e("span",{staticClass:"search-tip"},[t._v("当前显示搜索结果")]),e("el-button",{staticClass:"clear-search-btn",attrs:{type:"text"},on:{click:t.handleSearchClear}},[t._v(" 清除搜索 ")])],1):t._e()]),e("el-table",{directives:[{name:"loading",rawName:"v-loading",value:t.loading,expression:"loading"}],staticClass:"data-table clickable-row",staticStyle:{width:"100%"},attrs:{data:t.filteredWaterSources,"row-class-name":t.tableRowClassName,"empty-text":"暂无数据"},on:{"row-mouse-enter":t.handleRowMouseEnter,"row-mouse-leave":t.handleRowMouseLeave,"row-click":t.handleRowClick}},[e("el-table-column",{attrs:{prop:"strId",label:"ID",width:"120"},scopedSlots:t._u([{key:"default",fn:function(s){return[e("span",{staticClass:"id-text"},[t._v(t._s(s.row.strId))])]}}])}),e("el-table-column",{attrs:{prop:"sourceName",label:"名称","min-width":"180"},scopedSlots:t._u([{key:"default",fn:function(s){return[e("div",{staticClass:"source-name-cell"},[e("i",{staticClass:"el-icon-location source-icon"}),e("span",{staticClass:"source-name"},[t._v(t._s(s.row.sourceName))])])]}}])}),e("el-table-column",{attrs:{prop:"sourceType",label:"水源类型",width:"150"},scopedSlots:t._u([{key:"default",fn:function(s){return[e("el-tag",{staticClass:"source-type-tag",attrs:{type:t.getSourceTypeTagType(s.row.sourceType),effect:"dark"}},[e("i",{staticClass:"tag-icon",class:t.getSourceTypeIcon(s.row.sourceType)}),t._v(" "+t._s(t.getSourceTypeName(s.row.sourceType))+" ")])]}}])}),e("el-table-column",{attrs:{prop:"description",label:"描述","min-width":"220"},scopedSlots:t._u([{key:"default",fn:function(s){return[e("span",{staticClass:"description-text"},[t._v(t._s(s.row.description||"暂无描述"))])]}}])}),e("el-table-column",{attrs:{prop:"isActive",label:"状态",width:"100"},scopedSlots:t._u([{key:"default",fn:function(s){return[e("div",{staticClass:"status-cell"},[e("div",{class:["status-dot",s.row.isActive?"true":"false"]}),e("span",{staticClass:"status-text"},[t._v(t._s(s.row.isActive?"运行中":"已停用"))])])]}}])}),e("el-table-column",{attrs:{prop:"createdAt",label:"创建时间",width:"160"},scopedSlots:t._u([{key:"default",fn:function(s){return[e("span",{staticClass:"time-text"},[t._v(t._s(t.formatTime(s.row.createdAt)))])]}}])}),e("el-table-column",{attrs:{label:"操作",width:"200",fixed:"right"},scopedSlots:t._u([{key:"default",fn:function(s){return[e("div",{staticClass:"action-buttons"},[e("el-button",{staticClass:"btn-action view",attrs:{type:"text",size:"small"},on:{click:function(e){return t.handleView(s.row)}}},[e("i",{staticClass:"el-icon-view"})]),e("el-button",{staticClass:"btn-action edit",attrs:{type:"text",size:"small"},on:{click:function(e){return t.handleEdit(s.row)}}},[e("i",{staticClass:"el-icon-edit"})]),e("el-button",{staticClass:"btn-action delete",attrs:{type:"text",size:"small"},on:{click:function(e){return t.handleDelete(s.row.strId)}}},[e("i",{staticClass:"el-icon-delete"})])],1)]}}])})],1)],1)],1),e("div",{staticClass:"pagination-section"},[e("el-pagination",{staticClass:"pagination-control",attrs:{"current-page":t.currentPageIndex+1,"page-size":t.pageSize,total:t.totalRecords,layout:"prev, pager, next, jumper",disabled:t.isSearching},on:{"current-change":t.handlePageChange}}),e("div",{staticClass:"page-size-control"},[e("span",{staticClass:"size-label"},[t._v("每页显示:")]),e("el-select",{staticClass:"size-select",attrs:{size:"small",disabled:t.isSearching},on:{change:t.handlePageSizeChange},model:{value:t.pageSize,callback:function(e){t.pageSize=e},expression:"pageSize"}},[e("el-option",{attrs:{label:"5",value:"5"}}),e("el-option",{attrs:{label:"10",value:"10"}}),e("el-option",{attrs:{label:"20",value:"20"}}),e("el-option",{attrs:{label:"50",value:"50"}})],1),e("span",{staticClass:"size-label"},[t._v("条")])],1)],1)])]),t.showAddForm||t.showEditForm?e("WaterSourceForm",{attrs:{visible:t.showAddForm||t.showEditForm,"form-data":t.currentWaterSource,"is-edit":t.showEditForm},on:{close:t.handleFormClose,save:t.handleFormSave}}):t._e()],1)},B=[function(){var t=this,e=t._self._c;return e("div",{staticClass:"header-content"},[e("div",{staticClass:"title-section"},[e("h1",{staticClass:"main-title"},[t._v("水源监测点管理")]),e("p",{staticClass:"sub-title"},[t._v("实时监控水源状态与管理信息")])])])},function(){var t=this,e=t._self._c;return e("div",{staticClass:"feature-icon"},[e("i",{staticClass:"el-icon-plus"})])},function(){var t=this,e=t._self._c;return e("div",{staticClass:"feature-content"},[e("h3",[t._v("新增监测点")]),e("p",[t._v("添加新的水源监测位置")])])},function(){var t=this,e=t._self._c;return e("div",{staticClass:"feature-arrow"},[e("i",{staticClass:"el-icon-arrow-right"})])}],K=(s(2489),function(){var t=this,e=t._self._c;return e("el-dialog",{attrs:{title:"水源信息",visible:t.visible,width:"500px"},on:{close:function(e){return t.$emit("close")}}},[e("el-form",{ref:"form",attrs:{model:t.localFormData,rules:t.rules,"label-width":"100px"}},[e("el-form-item",{attrs:{label:"名称",prop:"sourceName"}},[e("el-input",{model:{value:t.localFormData.sourceName,callback:function(e){t.$set(t.localFormData,"sourceName",e)},expression:"localFormData.sourceName"}})],1),e("el-form-item",{attrs:{label:"水源类型",prop:"sourceType"}},[e("el-select",{attrs:{placeholder:"请选择水源类型"},model:{value:t.localFormData.sourceType,callback:function(e){t.$set(t.localFormData,"sourceType",e)},expression:"localFormData.sourceType"}},[e("el-option",{attrs:{label:"地下水",value:"GROUNDWATER"}}),e("el-option",{attrs:{label:"地表水",value:"SURFACE_WATER"}}),e("el-option",{attrs:{label:"水库",value:"RESERVOIR"}}),e("el-option",{attrs:{label:"河流",value:"RIVER"}}),e("el-option",{attrs:{label:"湖泊",value:"LAKE"}}),e("el-option",{attrs:{label:"饮用水",value:"DRINKING_WATER"}}),e("el-option",{attrs:{label:"工业用水",value:"INDUSTRIAL_WATER"}}),e("el-option",{attrs:{label:"农业用水",value:"AGRICULTURAL_WATER"}}),e("el-option",{attrs:{label:"污水处理厂",value:"SEWAGE_TREATMENT_PLANT"}}),e("el-option",{attrs:{label:"井水",value:"WELL_WATER"}}),e("el-option",{attrs:{label:"泉水",value:"SPRING_WATER"}})],1)],1),e("el-form-item",{attrs:{label:"描述",prop:"description"}},[e("el-input",{attrs:{type:"textarea"},model:{value:t.localFormData.description,callback:function(e){t.$set(t.localFormData,"description",e)},expression:"localFormData.description"}})],1),t.isEdit?e("el-form-item",{attrs:{label:"激活状态",prop:"isActive"}},[e("el-switch",{model:{value:t.localFormData.isActive,callback:function(e){t.$set(t.localFormData,"isActive",e)},expression:"localFormData.isActive"}})],1):t._e()],1),e("div",{staticClass:"dialog-footer",attrs:{slot:"footer"},slot:"footer"},[e("el-button",{on:{click:function(e){return t.$emit("close")}}},[t._v("取消")]),e("el-button",{attrs:{type:"primary"},on:{click:t.handleSubmit}},[t._v("确定")])],1)],1)}),Y=[],J=(s(3110),s(8335),{props:{visible:{type:Boolean,default:!1},formData:{type:Object,default:()=>({})},isEdit:{type:Boolean,default:!1}},data(){return{localFormData:{},rules:{sourceName:[{required:!0,message:"请输入水源名称",trigger:"blur"}],sourceType:[{required:!0,message:"请选择水源类型",trigger:"change"}]}}},watch:{formData:{immediate:!0,handler(t){this.localFormData=JSON.parse(JSON.stringify(t))}}},methods:{handleSubmit(){this.$refs.form.validate(t=>{t&&this.$emit("save",this.localFormData)})}}}),Q=J,X=(0,n.A)(Q,K,Y,!1,null,null,null),Z=X.exports,tt={components:{WaterSourceForm:Z,MainHeader:b},data(){return{waterSources:[],filteredWaterSources:[],pageSize:10,currentCursor:null,cursorHistory:[],hasPreviousPage:!1,hasNextPage:!1,showAddForm:!1,showEditForm:!1,currentWaterSource:{},currentPageIndex:0,searchId:"",loading:!1,totalRecords:0,isSearching:!1,searchLoading:!1}},computed:{currentRange(){const t=this.currentPageIndex*this.pageSize+1,e=t+this.filteredWaterSources.length-1;return`${t}-${e}`}},watch:{searchId(t){t||this.handleSearchClear()}},created(){this.loadWaterSources()},methods:{async loadWaterSources(){this.loading=!0;try{const t=await x.get("/water-sources",{params:{lastStrId:this.currentCursor,pageSize:this.pageSize}});let e=t.data;e&&void 0!==e.data&&(e=e.data),this.waterSources=e||[],this.filteredWaterSources=[...this.waterSources],this.hasNextPage=this.waterSources.length>=this.pageSize,this.waterSources.length>0&&(this.totalRecords=(this.currentPageIndex+1)*this.pageSize+(this.hasNextPage?1:0))}catch(t){this.$message.error("获取水源列表失败")}finally{this.loading=!1}},async handleSearchById(){if(this.searchId.trim()){this.searchLoading=!0,this.loading=!0,this.isSearching=!0;try{const e=this.searchId.trim();if(/^\d+$/.test(e))try{const t=await x.get(`/water-sources/${e}`);console.log("ID搜索响应:",t);let s=null;if(t.data&&(t.data.data?s=t.data.data:t.data.strId&&(s=t.data)),s)return this.filteredWaterSources=[s],void this.$message.success("搜索成功")}catch(t){console.log("ID搜索失败，尝试名称模糊搜索",t)}this.waterSources.length<this.pageSize&&await this.loadWaterSources();const s=this.waterSources.filter(t=>t.sourceName&&t.sourceName.toLowerCase().includes(e.toLowerCase()));s.length>0?(this.filteredWaterSources=s,this.$message.success(`找到 ${s.length} 个匹配的水源`)):(this.filteredWaterSources=[],this.$message.warning("未找到匹配的水源数据"),setTimeout(()=>{this.handleSearchClear()},1500))}catch(e){console.error("搜索错误:",e),this.filteredWaterSources=[],this.$message.error("搜索失败，请重试"),setTimeout(()=>{this.handleSearchClear()},1500)}finally{this.searchLoading=!1,this.loading=!1}}else this.$message.warning("请输入水源ID或名称")},handleSearchClear(){this.isSearching=!1,this.searchId="",this.searchLoading=!1,this.filteredWaterSources=[...this.waterSources]},refreshData(){this.currentCursor=null,this.cursorHistory=[],this.currentPageIndex=0,this.searchId="",this.isSearching=!1,this.searchLoading=!1,this.loadWaterSources(),this.$message.success("数据已刷新")},loadPreviousPage(){this.cursorHistory.length>0&&(this.currentCursor=this.cursorHistory.pop(),this.currentPageIndex--,this.loadWaterSources(),this.hasPreviousPage=this.cursorHistory.length>0)},loadNextPage(){if(this.waterSources.length>0){const t=this.waterSources[this.waterSources.length-1];t&&t.strId&&(this.cursorHistory.push(this.currentCursor),this.currentCursor=t.strId,this.currentPageIndex++,this.loadWaterSources(),this.hasPreviousPage=!0)}},handlePageChange(t){this.isSearching?this.$message.info("请先清除搜索条件"):t>this.currentPageIndex+1?this.loadNextPage():t<this.currentPageIndex+1&&this.loadPreviousPage()},handlePageSizeChange(){this.isSearching?this.$message.info("请先清除搜索条件"):(this.currentCursor=null,this.cursorHistory=[],this.currentPageIndex=0,this.loadWaterSources())},getSourceTypeName(t){const e={GROUNDWATER:"地下水",SURFACE_WATER:"地表水",RESERVOIR:"水库",RIVER:"河流",LAKE:"湖泊",DRINKING_WATER:"饮用水",INDUSTRIAL_WATER:"工业用水",AGRICULTURAL_WATER:"农业用水",SEWAGE_TREATMENT_PLANT:"污水处理厂",RAINWATER_COLLECTION:"雨水收集点",WELL_WATER:"井水",SPRING_WATER:"泉水"};return e[t]||t},getSourceTypeTagType(t){const e={GROUNDWATER:"info",SURFACE_WATER:"success",RESERVOIR:"warning",RIVER:"primary",LAKE:"danger",DRINKING_WATER:"success",INDUSTRIAL_WATER:"primary",AGRICULTURAL_WATER:"warning",SEWAGE_TREATMENT_PLANT:"info",RAINWATER_COLLECTION:"info",WELL_WATER:"primary",SPRING_WATER:"success"};return e[t]||"default"},getSourceTypeIcon(t){const e={GROUNDWATER:"el-icon-bottom",SURFACE_WATER:"el-icon-top",RESERVOIR:"el-icon-data-board",RIVER:"el-icon-trend-charts",LAKE:"el-icon-picture",DRINKING_WATER:"el-icon-cup",INDUSTRIAL_WATER:"el-icon-suitcase",AGRICULTURAL_WATER:"el-icon-shopping-bag-1",SEWAGE_TREATMENT_PLANT:"el-icon-recycle",RAINWATER_COLLECTION:"el-icon-cloud-rain",WELL_WATER:"el-icon-bottom",SPRING_WATER:"el-icon-waterlily"};return e[t]||"el-icon-help"},formatTime(t){if(!t)return"-";try{let e;if(Array.isArray(t)){const[s,a,r,i,o,l]=t;e=new Date(s,a-1,r,i,o,l)}else e=("string"===typeof t&&t.includes("T"),new Date(t));if(isNaN(e.getTime()))return t;const s=e.getFullYear(),a=String(e.getMonth()+1).padStart(2,"0"),r=String(e.getDate()).padStart(2,"0"),i=String(e.getHours()).padStart(2,"0"),o=String(e.getMinutes()).padStart(2,"0"),l=String(e.getSeconds()).padStart(2,"0");return`${s}-${a}-${r} ${i}:${o}:${l}`}catch(e){return console.error("日期格式化错误:",e),t}},tableRowClassName({rowIndex:t}){return t%2===0?"even-row":"odd-row"},handleRowMouseEnter(t,e,s,a){a.currentTarget.classList.add("hover-row"),a.currentTarget.classList.add("shake-animation"),setTimeout(()=>{a.currentTarget.classList.remove("shake-animation")},500)},handleRowMouseLeave(t,e,s,a){a.currentTarget.classList.remove("hover-row")},handleRowClick(t){localStorage.setItem("selectedWaterSourceId",t.strId),localStorage.setItem("selectedWaterSourceName",t.sourceName),this.$message.success(`已选择水源: ${t.sourceName} (ID: ${t.strId})`)},handleAdd(){this.currentWaterSource={sourceName:"",sourceType:"",description:"",active:!0},this.showAddForm=!0,this.showEditForm=!1},handleView(t){this.currentWaterSource={...t},this.showAddForm=!1,this.showEditForm=!0},handleEdit(t){this.currentWaterSource={...t},this.showAddForm=!1,this.showEditForm=!0},async handleDelete(t){this.$confirm("确定要删除这个水源吗?","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning",customClass:"delete-confirm"}).then(async()=>{try{await x.delete(`/water-sources/${t}`),this.$message.success("删除成功"),this.currentCursor=null,this.cursorHistory=[],this.currentPageIndex=0,this.loadWaterSources()}catch(e){this.$message.error("删除失败")}}).catch(()=>{this.$message.info("已取消删除")})},handleFormClose(){this.showAddForm=!1,this.showEditForm=!1,this.currentWaterSource={}},async handleFormSave(t){try{this.showEditForm?(await x.put(`/water-sources/${t.strId}`,t),this.$message.success("更新成功")):(await x.post("/water-sources",t),this.$message.success("创建成功")),this.handleFormClose(),this.currentCursor=null,this.cursorHistory=[],this.currentPageIndex=0,this.loadWaterSources()}catch(e){this.$message.error("操作失败: "+(e.response?.data?.message||e.message))}}}},et=tt,st=(0,n.A)(et,j,B,!1,null,"59bab23d",null),at=st.exports,rt=function(){var t=this,e=t._self._c;return e("div",{staticClass:"user-settings-container"},[e("MainHeader"),e("div",{staticClass:"settings-layout"},[e("div",{staticClass:"sidebar-nav"},[e("div",{staticClass:"user-profile-card"},[e("div",{staticClass:"avatar-container"},[t.userInfo&&t.userInfo.avatar&&!t.avatarLoadError?e("img",{staticClass:"avatar-image",attrs:{src:t.getAvatarUrl(t.userInfo.avatar),alt:"用户头像"},on:{error:t.handleAvatarError,load:t.handleAvatarLoad}}):e("div",{staticClass:"avatar-default"},[e("i",{staticClass:"el-icon-user avatar-icon"})])]),e("div",{staticClass:"user-info"},[e("h2",{staticClass:"username"},[t._v(t._s(t.userInfo&&t.userInfo.username||"用户"))]),t._m(0)])]),e("el-menu",{staticClass:"sidebar-menu",attrs:{"default-active":t.activeMenu},on:{select:t.handleMenuSelect}},[e("el-menu-item",{attrs:{index:"profile"}},[e("i",{staticClass:"el-icon-user"}),e("span",[t._v("个人信息")])]),e("el-menu-item",{attrs:{index:"avatar"}},[e("i",{staticClass:"el-icon-camera"}),e("span",[t._v("头像设置")])])],1)],1),e("div",{staticClass:"content-area"},["profile"===t.activeMenu?e("div",{staticClass:"content-section"},[t._m(1),e("div",{staticClass:"profile-info"},[e("div",{staticClass:"info-card"},[e("div",{staticClass:"info-content"},[e("div",{staticClass:"info-item"},[e("span",{staticClass:"info-label"},[t._v("用户名：")]),e("span",{staticClass:"info-value"},[t._v(t._s(t.userInfo.username||"未设置"))]),e("el-button",{staticClass:"edit-btn",attrs:{type:"text"},on:{click:t.showUsernameDialog}},[t._v(" 修改 ")])],1),e("div",{staticClass:"info-item"},[e("span",{staticClass:"info-label"},[t._v("用户ID：")]),e("span",{staticClass:"info-value"},[t._v(t._s(t.userInfo.strId||"未知"))])]),e("div",{staticClass:"info-item"},[e("span",{staticClass:"info-label"},[t._v("电子邮箱：")]),e("span",{staticClass:"info-value"},[t._v(t._s(t.userInfo.email||"未设置"))]),e("el-button",{staticClass:"edit-btn",attrs:{type:"text"},on:{click:t.showEmailDialog}},[t._v(" 修改 ")])],1),e("div",{staticClass:"info-item"},[e("span",{staticClass:"info-label"},[t._v("密码：")]),e("span",{staticClass:"info-value"},[t._v("******")]),e("el-button",{staticClass:"edit-btn",attrs:{type:"text"},on:{click:t.showPasswordDialog}},[t._v(" 修改 ")])],1)])]),e("div",{staticClass:"info-card account-actions-card"},[e("div",{staticClass:"info-content account-actions"},[e("el-button",{staticClass:"action-btn",attrs:{type:"warning"},on:{click:t.handleLogout}},[e("i",{staticClass:"el-icon-switch-button"}),t._v(" 退出登录 ")]),e("el-button",{staticClass:"action-btn",attrs:{type:"danger"},on:{click:t.handleDeleteAccount}},[e("i",{staticClass:"el-icon-delete"}),t._v(" 注销账户 ")])],1)])])]):t._e(),"avatar"===t.activeMenu?e("div",{staticClass:"content-section"},[t._m(2),e("div",{staticClass:"avatar-upload-section"},[e("div",{staticClass:"current-avatar"},[e("h4",[t._v("当前头像")]),e("div",{staticClass:"avatar-preview"},[t.userInfo&&t.userInfo.avatar&&!t.avatarLoadError?e("img",{attrs:{src:t.getAvatarUrl(t.userInfo.avatar),alt:"当前头像"},on:{error:t.handleAvatarError,load:t.handleAvatarLoad}}):e("div",{staticClass:"avatar-placeholder"},[e("i",{staticClass:"el-icon-user"})])]),t.avatarLoadError?e("p",{staticClass:"avatar-error-tip"},[t._v("头像加载失败")]):t._e()]),e("div",{staticClass:"upload-area"},[e("h4",[t._v("上传新头像")]),e("el-upload",{staticClass:"avatar-uploader",attrs:{action:"#","show-file-list":!1,"before-upload":t.beforeAvatarUpload,"http-request":t.customUpload}},[e("div",{staticClass:"upload-trigger"},[e("i",{staticClass:"el-icon-upload"}),e("div",{staticClass:"upload-text"},[e("p",[t._v("点击上传头像")]),e("p",{staticClass:"upload-tips"},[t._v("支持 JPG、PNG 格式，大小不超过 2MB")])])])])],1)])]):t._e()])]),e("el-dialog",{attrs:{title:"修改用户名",visible:t.usernameDialogVisible,width:"400px"},on:{"update:visible":function(e){t.usernameDialogVisible=e}}},[e("el-form",{ref:"usernameForm",attrs:{model:t.usernameForm,rules:t.usernameRules}},[e("el-form-item",{attrs:{label:"新用户名",prop:"username"}},[e("el-input",{attrs:{placeholder:"请输入新用户名"},model:{value:t.usernameForm.username,callback:function(e){t.$set(t.usernameForm,"username",e)},expression:"usernameForm.username"}})],1)],1),e("span",{staticClass:"dialog-footer",attrs:{slot:"footer"},slot:"footer"},[e("el-button",{on:{click:function(e){t.usernameDialogVisible=!1}}},[t._v("取消")]),e("el-button",{attrs:{type:"primary",loading:t.usernameLoading},on:{click:t.updateUsername}},[t._v("确认")])],1)],1),e("el-dialog",{attrs:{title:"修改邮箱",visible:t.emailDialogVisible,width:"400px"},on:{"update:visible":function(e){t.emailDialogVisible=e}}},[e("el-form",{ref:"emailForm",attrs:{model:t.emailForm,rules:t.emailRules}},[e("el-form-item",{attrs:{label:"新邮箱",prop:"email"}},[e("el-input",{attrs:{placeholder:"请输入新邮箱地址"},model:{value:t.emailForm.email,callback:function(e){t.$set(t.emailForm,"email",e)},expression:"emailForm.email"}})],1)],1),e("span",{staticClass:"dialog-footer",attrs:{slot:"footer"},slot:"footer"},[e("el-button",{on:{click:function(e){t.emailDialogVisible=!1}}},[t._v("取消")]),e("el-button",{attrs:{type:"primary",loading:t.emailLoading},on:{click:t.updateEmail}},[t._v("确认")])],1)],1),e("el-dialog",{attrs:{title:"修改密码",visible:t.passwordDialogVisible,width:"400px"},on:{"update:visible":function(e){t.passwordDialogVisible=e}}},[e("el-form",{ref:"passwordForm",attrs:{model:t.passwordForm,rules:t.passwordRules}},[e("el-form-item",{attrs:{label:"新密码",prop:"newPassword"}},[e("el-input",{attrs:{type:"password",placeholder:"请输入新密码","show-password":""},model:{value:t.passwordForm.newPassword,callback:function(e){t.$set(t.passwordForm,"newPassword",e)},expression:"passwordForm.newPassword"}})],1),e("el-form-item",{attrs:{label:"确认密码",prop:"confirmPassword"}},[e("el-input",{attrs:{type:"password",placeholder:"请再次输入新密码","show-password":""},model:{value:t.passwordForm.confirmPassword,callback:function(e){t.$set(t.passwordForm,"confirmPassword",e)},expression:"passwordForm.confirmPassword"}})],1)],1),e("span",{staticClass:"dialog-footer",attrs:{slot:"footer"},slot:"footer"},[e("el-button",{on:{click:function(e){t.passwordDialogVisible=!1}}},[t._v("取消")]),e("el-button",{attrs:{type:"primary",loading:t.passwordLoading},on:{click:t.updatePassword}},[t._v("确认")])],1)],1),e("el-dialog",{attrs:{title:"谨慎操作",visible:t.deleteAccountDialogVisible,width:"400px","close-on-click-modal":!1},on:{"update:visible":function(e){t.deleteAccountDialogVisible=e}}},[e("div",{staticClass:"delete-warning"},[e("div",{staticClass:"warning-icon"},[e("i",{staticClass:"el-icon-warning-outline"})]),e("div",{staticClass:"warning-content"},[e("p",{staticClass:"warning-title"},[t._v("确定要注销您的账户吗？")]),e("ul",{staticClass:"warning-list"},[e("li",[t._v("• 账户注销后，所有数据将永久删除且无法恢复")]),e("li",[t._v("• 您将无法再使用该账户登录系统")]),e("li",[t._v("• 相关的所有记录和设置都将被清除")])]),e("p",{staticClass:"confirm-text"},[t._v('请输入"确认注销"以继续操作')]),e("el-input",{staticClass:"confirm-input",attrs:{placeholder:"请输入确认信息"},model:{value:t.deleteConfirmText,callback:function(e){t.deleteConfirmText=e},expression:"deleteConfirmText"}})],1)]),e("span",{staticClass:"dialog-footer",attrs:{slot:"footer"},slot:"footer"},[e("el-button",{on:{click:function(e){t.deleteAccountDialogVisible=!1}}},[t._v("取消")]),e("el-button",{attrs:{type:"danger",disabled:"确认注销"!==t.deleteConfirmText},on:{click:t.confirmDeleteAccount}},[t._v(" 确认注销 ")])],1)])],1)},it=[function(){var t=this,e=t._self._c;return e("div",{staticClass:"status-indicator"},[e("div",{staticClass:"status-dot active"}),e("span",{staticClass:"status-text"},[t._v("在线")])])},function(){var t=this,e=t._self._c;return e("h3",{staticClass:"section-title"},[e("i",{staticClass:"el-icon-user"}),t._v(" 个人信息 ")])},function(){var t=this,e=t._self._c;return e("h3",{staticClass:"section-title"},[e("i",{staticClass:"el-icon-camera"}),t._v(" 头像设置 ")])}],ot={name:"UserSettings",components:{MainHeader:b},data(){const t=(t,e,s)=>{e!==this.passwordForm.newPassword?s(new Error("两次输入的密码不一致")):s()},e=(t,e,s)=>{e&&!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)?s(new Error("请输入有效的邮箱地址")):s()};return{activeMenu:"profile",userInfo:{},avatarTimestamp:Date.now(),showApiKey:!1,avatarLoadError:!1,usernameDialogVisible:!1,emailDialogVisible:!1,passwordDialogVisible:!1,deleteAccountDialogVisible:!1,deleteConfirmText:"",usernameForm:{username:""},usernameLoading:!1,usernameRules:{username:[{required:!0,message:"请输入用户名",trigger:"blur"},{min:2,max:20,message:"用户名长度在 2 到 20 个字符",trigger:"blur"}]},emailForm:{email:""},emailLoading:!1,emailRules:{email:[{required:!0,message:"请输入邮箱地址",trigger:"blur"},{validator:e,trigger:"blur"}]},passwordForm:{newPassword:"",confirmPassword:""},passwordLoading:!1,passwordRules:{newPassword:[{required:!0,message:"请输入新密码",trigger:"blur"},{min:6,message:"密码长度至少 6 个字符",trigger:"blur"}],confirmPassword:[{required:!0,message:"请确认密码",trigger:"blur"},{validator:t,trigger:"blur"}]}}},computed:{},created(){this.loadUserInfo()},methods:{getAvatarUrl(t){if(!t)return this.avatarLoadError=!0,"";try{if(t.startsWith("http"))return t;const e="",s=e.endsWith("/")?e.slice(0,-1):e;let a=t;return a.startsWith("/")||(a="/"+a),`${s}${a}`}catch(e){return console.error("构建头像URL失败:",e),this.avatarLoadError=!0,""}},handleAvatarLoad(){this.avatarLoadError=!1,console.log("头像加载成功")},handleAvatarError(t){console.error("头像加载失败:",t),this.avatarLoadError=!0,console.log("头像URL:",t.target.src),console.log("用户头像路径:",this.userInfo.avatar)},async loadUserInfo(){try{this.avatarLoadError=!1;const t=await x.get("/auth/me");this.userInfo=t.data||{},console.info("用户信息:",this.userInfo),this.userInfo.avatar&&(console.log("头像路径:",this.userInfo.avatar),console.log("构建的完整URL:",this.getAvatarUrl(this.userInfo.avatar))),this.avatarTimestamp=Date.now()}catch(t){console.error("获取用户信息失败:",t),this.userInfo={},this.$message.error("获取用户信息失败")}},formatDate(t){return t?new Date(t).toLocaleString("zh-CN"):"未知"},handleMenuSelect(t){this.activeMenu=t},showUsernameDialog(){this.usernameForm.username=this.userInfo.username||"",this.usernameDialogVisible=!0,this.$nextTick(()=>{this.$refs.usernameForm&&this.$refs.usernameForm.clearValidate()})},showEmailDialog(){this.emailForm.email=this.userInfo.email||"",this.emailDialogVisible=!0,this.$nextTick(()=>{this.$refs.emailForm&&this.$refs.emailForm.clearValidate()})},showPasswordDialog(){this.passwordForm.newPassword="",this.passwordForm.confirmPassword="",this.passwordDialogVisible=!0,this.$nextTick(()=>{this.$refs.passwordForm&&this.$refs.passwordForm.clearValidate()})},async updateUsername(){try{await this.$refs.usernameForm.validate(),this.usernameLoading=!0;const t={username:this.usernameForm.username};await x.post("/auth/update",t),this.$message.success("用户名更新成功"),this.usernameDialogVisible=!1,this.loadUserInfo()}catch(t){"cancel"!==t&&(console.error("更新用户名失败:",t),this.$message.error("更新用户名失败"))}finally{this.usernameLoading=!1}},async updateEmail(){try{await this.$refs.emailForm.validate(),this.emailLoading=!0;const t={email:this.emailForm.email};await x.post("/auth/update",t),this.$message.success("邮箱更新成功"),this.emailDialogVisible=!1,this.loadUserInfo()}catch(t){"cancel"!==t&&(console.error("更新邮箱失败:",t),this.$message.error("更新邮箱失败"))}finally{this.emailLoading=!1}},async updatePassword(){try{await this.$refs.passwordForm.validate(),this.passwordLoading=!0;const t={password:this.passwordForm.newPassword};await x.post("/auth/update",t),this.$message.success("密码修改成功"),this.passwordDialogVisible=!1,this.resetPasswordForm()}catch(t){"cancel"!==t&&(console.error("修改密码失败:",t),this.$message.error("修改密码失败"))}finally{this.passwordLoading=!1}},resetPasswordForm(){this.passwordForm.newPassword="",this.passwordForm.confirmPassword=""},async customUpload(t){try{const e=new FormData;e.append("file",t.file),this.$message.info("头像上传中...");const s=await x.post("/auth/updateavatar",e,{headers:{"Content-Type":"multipart/form-data"}});s.data&&200===s.data.code&&(this.$message.success("头像上传成功"),this.avatarTimestamp=Date.now(),this.avatarLoadError=!1,this.loadUserInfo())}catch(e){console.error("头像上传错误:",e),e.response&&403===e.response.status?this.$message.error("上传失败：权限不足，请重新登录"):this.$message.error("头像上传失败，请检查网络连接")}},beforeAvatarUpload(t){const e=localStorage.getItem("token");if(!e)return this.$message.error("请先登录"),!1;const s="image/jpeg"===t.type||"image/png"===t.type||"image/gif"===t.type||"image/webp"===t.type,a=t.size/1024/1024<2;return s?!!a||(this.$message.error("上传头像图片大小不能超过 2MB!"),!1):(this.$message.error("上传头像图片只能是 JPG/PNG/GIF/WEBP 格式!"),!1)},goBack(){window.history.length>1?this.$router.go(-1):this.$router.push("/water-sources")},async handleLogout(){try{await this.$confirm("确定要退出登录吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await x.delete("/auth/logout"),localStorage.removeItem("token"),this.$router.push("/"),this.$message.success("已退出登录")}catch(t){"cancel"!==t&&this.$message.error("退出登录失败")}},handleDeleteAccount(){this.deleteConfirmText="",this.deleteAccountDialogVisible=!0},async confirmDeleteAccount(){try{await x.delete("/auth/me"),localStorage.removeItem("token"),this.$router.push("/"),this.$message.success("账户已成功删除"),this.deleteAccountDialogVisible=!1}catch(t){this.$message.error("删除账户失败")}}}},lt=ot,nt=(0,n.A)(lt,rt,it,!1,null,"0712e728",null),ct=nt.exports,dt=function(){var t=this,e=t._self._c;return e("div",{staticClass:"water-data-upload"},[e("div",{staticClass:"upload-content"},[e("el-form",{ref:"uploadForm",staticClass:"upload-form",attrs:{model:t.form,rules:t.rules,"label-width":"120px"}},[e("el-form-item",{attrs:{label:"水源ID",prop:"sourceStrId"}},[e("el-input",{staticClass:"form-input",attrs:{placeholder:"请输入水源ID",clearable:""},model:{value:t.form.sourceStrId,callback:function(e){t.$set(t.form,"sourceStrId",e)},expression:"form.sourceStrId"}},[e("template",{slot:"prepend"},[e("i",{staticClass:"el-icon-water-tap"})])],2)],1),e("el-form-item",{attrs:{label:"浊度值",prop:"turbidityValue"}},[e("el-input",{staticClass:"form-input",attrs:{placeholder:"请输入浊度值",type:"number",step:"0.01",clearable:""},model:{value:t.form.turbidityValue,callback:function(e){t.$set(t.form,"turbidityValue",t._n(e))},expression:"form.turbidityValue"}},[e("template",{slot:"prepend"},[e("i",{staticClass:"el-icon-data-line"})])],2),e("div",{staticClass:"form-tip"},[t._v("请输入0-1000之间的浊度值")])],1),e("el-form-item",{attrs:{label:"单位",prop:"unit"}},[e("el-select",{staticClass:"form-input",attrs:{placeholder:"请选择单位"},model:{value:t.form.unit,callback:function(e){t.$set(t.form,"unit",e)},expression:"form.unit"}},t._l(t.unitOptions,function(t){return e("el-option",{key:t.value,attrs:{label:t.label,value:t.value}})}),1)],1),e("el-form-item",{attrs:{label:"测量时间",prop:"measuredAt"}},[e("el-date-picker",{staticClass:"form-input",attrs:{type:"datetime",placeholder:"选择测量时间",format:"yyyy-MM-dd HH:mm:ss","value-format":"yyyy-MM-ddTHH:mm:ss",editable:!1},model:{value:t.form.measuredAt,callback:function(e){t.$set(t.form,"measuredAt",e)},expression:"form.measuredAt"}}),e("div",{staticClass:"form-tip"},[t._v("不选择则使用当前时间")])],1),e("el-card",{staticClass:"preview-card",attrs:{shadow:"never"}},[e("div",{staticClass:"preview-header",attrs:{slot:"header"},slot:"header"},[e("span",[t._v("数据预览")])]),e("div",{staticClass:"preview-content"},[e("div",{staticClass:"preview-item"},[e("label",[t._v("水源ID:")]),e("span",{staticClass:"preview-value"},[t._v(t._s(t.form.sourceStrId||"未填写"))])]),e("div",{staticClass:"preview-item"},[e("label",[t._v("浊度值:")]),e("span",{staticClass:"preview-value",class:t.getTurbidityClass(t.form.turbidityValue)},[t._v(" "+t._s(t.form.turbidityValue||"未填写")+" NTU ")])]),e("div",{staticClass:"preview-item"},[e("label",[t._v("测量时间:")]),e("span",{staticClass:"preview-value"},[t._v(t._s(t.formatPreviewTime(t.form.measuredAt)))])])])]),e("div",{staticClass:"form-actions"},[e("el-button",{staticClass:"cancel-btn",on:{click:t.handleCancel}},[t._v(" 取消 ")]),e("el-button",{staticClass:"submit-btn",attrs:{type:"primary",loading:t.loading},on:{click:t.handleSubmit}},[e("i",{staticClass:"el-icon-upload"}),t._v(" 上传数据 ")])],1)],1),t.showHistory?e("div",{staticClass:"history-section"},[e("el-divider",{attrs:{"content-position":"left"}},[t._v("历史数据")]),e("div",{staticClass:"history-toolbar"},[e("el-input",{staticStyle:{width:"200px","margin-right":"10px"},attrs:{placeholder:"搜索历史数据...","prefix-icon":"el-icon-search",clearable:""},model:{value:t.historySearch,callback:function(e){t.historySearch=e},expression:"historySearch"}}),e("el-button",{attrs:{type:"text",icon:"el-icon-refresh",loading:t.historyLoading},on:{click:t.loadHistoryData}},[t._v(" 刷新 ")])],1),e("el-table",{directives:[{name:"loading",rawName:"v-loading",value:t.historyLoading,expression:"historyLoading"}],staticClass:"history-table",staticStyle:{width:"100%","margin-top":"16px"},attrs:{data:t.filteredHistoryData,"empty-text":"暂无历史数据"}},[e("el-table-column",{attrs:{prop:"timestamp",label:"时间",width:"180"},scopedSlots:t._u([{key:"default",fn:function(e){return[t._v(" "+t._s(t.formatTime(e.row.timestamp))+" ")]}}],null,!1,1514238020)}),e("el-table-column",{attrs:{prop:"turbidity",label:"浊度值",width:"120"},scopedSlots:t._u([{key:"default",fn:function(s){return[e("span",{class:t.getTurbidityClass(s.row.turbidity)},[t._v(" "+t._s(s.row.turbidity)+" NTU ")])]}}],null,!1,814299862)}),e("el-table-column",{attrs:{prop:"sourceStrId",label:"水源ID"}})],1)],1):t._e()],1)])},ut=[],pt={name:"WaterDataUpload",data(){const t=(t,e,s)=>{""===e||null===e||void 0===e?s(new Error("请输入浊度值")):isNaN(e)?s(new Error("浊度值必须为数字")):e<0||e>1e3?s(new Error("浊度值必须在0-1000之间")):s()};return{loading:!1,historyLoading:!1,form:{sourceStrId:"",turbidityValue:null,unit:"NTU",measuredAt:""},rules:{sourceStrId:[{required:!0,message:"请输入水源ID",trigger:"blur"}],turbidityValue:[{required:!0,validator:t,trigger:"blur"}],unit:[{required:!0,message:"请选择单位",trigger:"change"}],measuredAt:[{required:!0,message:"请选择测量时间",trigger:"change"}]},showHistory:!1,historyData:[],historySearch:"",filteredHistoryData:[],unitOptions:[{label:"NTU",value:"NTU"},{label:"FTU",value:"FTU"},{label:"FAU",value:"FAU"}]}},computed:{computedHistoryData(){return this.historySearch?this.historyData.filter(t=>t.sourceStrId.toLowerCase().includes(this.historySearch.toLowerCase())||t.turbidity.toString().includes(this.historySearch)):this.historyData}},watch:{"form.sourceStrId"(t){t?(this.showHistory=!0,this.loadHistoryData()):(this.showHistory=!1,this.historyData=[])},historySearch(){this.filterHistoryData()}},methods:{handleSubmit(){this.$refs.uploadForm.validate(async t=>{if(t){this.loading=!0;try{const t={sourceStrId:this.form.sourceStrId,turbidityValue:parseFloat(this.form.turbidityValue),unit:this.form.unit,measuredAt:this.form.measuredAt||this.getCurrentDateTime()};this.form.timestamp&&(t.timestamp=this.form.timestamp),await x.post("/water-data/upload",t),this.$message.success("水质数据上传成功！"),this.resetForm(),this.loadHistoryData(),this.$emit("success")}catch(e){console.error("上传失败:",e),this.$message.error("上传失败: "+(e.response?.data?.message||e.message))}finally{this.loading=!1}}else this.$message.warning("请完善表单信息")})},getCurrentDateTime(){const t=new Date;return t.toISOString().slice(0,19)},resetForm(){this.form.turbidityValue=null,this.form.measuredAt="",this.$refs.uploadForm.clearValidate()},handleCancel(){this.$emit("close")},async loadHistoryData(){if(this.form.sourceStrId){this.historyLoading=!0;try{const t=await x.get(`/water-data/query/${this.form.sourceStrId}`);let e=t.data;e&&void 0!==e.data&&(e=e.data),this.historyData=e||[],this.filterHistoryData()}catch(t){console.error("加载历史数据失败:",t),t.response&&404!==t.response.status&&this.$message.error("加载历史数据失败")}finally{this.historyLoading=!1}}},filterHistoryData(){this.historySearch?this.filteredHistoryData=this.historyData.filter(t=>t.sourceStrId.toLowerCase().includes(this.historySearch.toLowerCase())||t.turbidity.toString().includes(this.historySearch)):this.filteredHistoryData=[...this.historyData]},getTurbidityClass(t){return t||0===t?t<1?"turbidity-excellent":t<5?"turbidity-good":t<10?"turbidity-fair":"turbidity-poor":""},formatPreviewTime(t){return t?this.formatTime(t):"当前时间"},formatTime(t){if(!t)return"-";try{const e=new Date(t);if(isNaN(e.getTime()))return t;const s=e.getFullYear(),a=String(e.getMonth()+1).padStart(2,"0"),r=String(e.getDate()).padStart(2,"0"),i=String(e.getHours()).padStart(2,"0"),o=String(e.getMinutes()).padStart(2,"0"),l=String(e.getSeconds()).padStart(2,"0");return`${s}-${a}-${r} ${i}:${o}:${l}`}catch(e){return t}}}},ht=pt,mt=(0,n.A)(ht,dt,ut,!1,null,"6503703a",null),vt=mt.exports,gt=function(){var t=this,e=t._self._c;return e("div",{staticClass:"app-container"},[e("MainHeader"),t._m(0),e("nav",{staticClass:"module-nav"},[e("div",{staticClass:"container"},[e("button",{staticClass:"nav-btn",class:{active:"private-report"===t.activeModule},on:{click:function(e){return t.switchModule("private-report")}}},[e("i",{staticClass:"fa fa-file-text-o nav-icon"}),t._v(" 私有分析报告 ")]),e("button",{staticClass:"nav-btn",class:{active:"public-report"===t.activeModule},on:{click:function(e){return t.switchModule("public-report")}}},[e("i",{staticClass:"fa fa-qrcode nav-icon"}),t._v(" 公开分析报告 ")])])]),e("main",{staticClass:"container main-content"},[e("section",{directives:[{name:"show",rawName:"v-show",value:"private-report"===t.activeModule,expression:"activeModule === 'private-report'"}],staticClass:"module-panel"},[e("div",{staticClass:"header-section"},[t._m(1),e("div",{staticClass:"feature-cards-horizontal"},[e("div",{staticClass:"feature-card",on:{click:function(e){t.showGenerateModal=!0}}},[t._m(2),t._m(3),t._m(4)])])]),e("div",{staticClass:"toolbar-section"},[e("div",{staticClass:"search-box"},[e("el-input",{staticClass:"search-input",attrs:{placeholder:"按水源ID搜索...","prefix-icon":"el-icon-search",clearable:""},on:{clear:t.handleSearchClear,keyup:function(e){return!e.type.indexOf("key")&&t._k(e.keyCode,"enter",13,e.key,"Enter")?null:t.handleSearchBySourceId.apply(null,arguments)}},model:{value:t.searchSourceId,callback:function(e){t.searchSourceId=e},expression:"searchSourceId"}}),e("el-button",{staticClass:"search-btn",attrs:{type:"primary",loading:t.searchLoading},on:{click:t.handleSearchBySourceId}},[t._v(" 搜索 ")])],1)]),e("div",{staticClass:"reports-grid"},[t._l(t.filteredReports,function(s){return e("div",{key:s.strId,staticClass:"report-card"},[t._m(5,!0),e("div",{staticClass:"report-content"},[e("div",{staticClass:"report-meta"},[e("div",{staticClass:"meta-item"},[e("i",{staticClass:"fa fa-file-text-o meta-icon"}),e("span",{staticClass:"meta-label"},[t._v("报告ID:")]),e("span",{staticClass:"meta-value copyable-id",on:{click:function(e){return t.copyReportId(s.strId)}}},[t._v(" "+t._s(s.strId)+" "),e("i",{staticClass:"fa fa-copy copy-icon"})])]),e("div",{staticClass:"meta-item"},[e("i",{staticClass:"fa fa-clock-o meta-icon"}),e("span",{staticClass:"meta-label"},[t._v("生成时间:")]),e("span",{staticClass:"meta-value"},[t._v(t._s(t.formatDateTime(s.generatedAt)))])]),s.keywords?e("div",{staticClass:"meta-item"},[e("i",{staticClass:"fa fa-tags meta-icon"}),e("span",{staticClass:"meta-label"},[t._v("关键词:")]),e("span",{staticClass:"meta-value"},[t._v(t._s(s.keywords))])]):t._e()])]),e("div",{staticClass:"report-actions"},[e("el-button",{staticClass:"btn-action view",attrs:{type:"text",size:"small"},on:{click:function(e){return t.viewPrivateReport(s)}}},[e("i",{staticClass:"fa fa-eye"}),t._v(" 查看详情 ")]),e("el-button",{class:["btn-action",s.isPublished?"unpublish":"publish"],attrs:{type:"text",size:"small"},on:{click:function(e){return t.togglePublishStatus(s)}}},[e("i",{class:s.isPublished?"fa fa-check":"fa fa-share"}),t._v(" "+t._s(s.isPublished?"取消发布":"发布")+" ")]),e("el-button",{staticClass:"btn-action delete",attrs:{type:"text",size:"small"},on:{click:function(e){return t.deleteReport(s.strId)}}},[e("i",{staticClass:"fa fa-trash"}),t._v(" 删除 ")])],1)])}),0!==t.filteredReports.length||t.loading.privateReports?t._e():e("div",{staticClass:"empty-state"},[t._m(6),e("p",{staticClass:"empty-tip"},[t._v("暂无私有分析报告")]),e("p",{staticClass:"empty-subtip"},[t._v('点击"生成新报告"创建你的第一份报告')])])],2),t.loading.privateReports?e("div",{staticClass:"loading-state"},[e("i",{staticClass:"fa fa-spinner fa-spin loading-icon"}),e("p",[t._v("加载中...")])]):t._e()]),e("section",{directives:[{name:"show",rawName:"v-show",value:"public-report"===t.activeModule,expression:"activeModule === 'public-report'"}],staticClass:"module-panel"},[e("div",{staticClass:"panel-header"},[t._m(7),e("div",{staticClass:"public-search"},[e("div",{staticClass:"form-input-group public-search-input"},[e("i",{staticClass:"fa fa-search input-icon"}),e("input",{directives:[{name:"model",rawName:"v-model",value:t.publicReportId,expression:"publicReportId"}],attrs:{type:"text",placeholder:"输入公开报告ID"},domProps:{value:t.publicReportId},on:{keyup:function(e){return!e.type.indexOf("key")&&t._k(e.keyCode,"enter",13,e.key,"Enter")?null:t.queryPublicReport.apply(null,arguments)},input:function(e){e.target.composing||(t.publicReportId=e.target.value)}}})]),e("button",{staticClass:"btn primary-btn",attrs:{disabled:t.loading.publicReport},on:{click:t.queryPublicReport}},[e("i",{staticClass:"fa fa-qrcode"}),t._v(" 搜索 ")])])]),e("div",{staticClass:"public-report-detail"},[t.publicReportDetail||t.loading.publicReport?t.loading.publicReport?e("div",{staticClass:"loading-state"},[e("i",{staticClass:"fa fa-spinner fa-spin loading-icon"}),e("p",[t._v("查询报告中...")])]):t.publicReportDetail?e("div",{staticClass:"report-content"},[t._m(9),e("div",{staticClass:"report-info"},[e("span",[e("i",{staticClass:"fa fa-file-text-o"}),t._v(" 报告ID： "),e("span",{staticClass:"copyable-id",on:{click:function(e){return t.copyReportId(t.publicReportDetail.strId)}}},[t._v(" "+t._s(t.publicReportDetail.strId)+" "),e("i",{staticClass:"fa fa-copy copy-icon"})])]),e("span",[e("i",{staticClass:"fa fa-tint"}),t._v(" 水源名称："+t._s(t.publicReportDetail.sourceName||"未知"))]),e("span",[e("i",{staticClass:"fa fa-tag"}),t._v(" 水源类型："+t._s(t.publicReportDetail.sourceType||"未知"))]),e("span",[e("i",{staticClass:"fa fa-calendar"}),t._v(" 生成时间："+t._s(t.formatDateTime(t.publicReportDetail.generatedAt)))]),t.publicReportDetail.keywords?e("span",[e("i",{staticClass:"fa fa-tags"}),t._v(" 关键词："+t._s(t.publicReportDetail.keywords))]):t._e()]),e("div",{staticClass:"report-text"},[e("h4",[t._v("报告内容")]),e("div",{staticClass:"formatted-report-content",domProps:{innerHTML:t._s(t.formatReportContent(t.publicReportDetail.reportContent))}})]),t.publicReportDetail.qrCodePath?e("div",{staticClass:"qr-code-section"},[e("h4",[t._v("二维码")]),e("img",{staticClass:"qr-code-image",attrs:{src:t.getQrCodeUrl(t.publicReportDetail.qrCodePath),alt:"报告二维码"}})]):t._e()]):t._e():e("div",{staticClass:"empty-state"},[t._m(8),e("p",{staticClass:"empty-tip"},[t._v("请输入公开报告ID，查询报告详情")])])])])]),t.showGenerateModal?e("div",{staticClass:"modal"},[e("div",{staticClass:"modal-overlay",on:{click:function(e){t.showGenerateModal=!1}}}),e("div",{staticClass:"modal-content"},[e("div",{staticClass:"modal-header"},[t._m(10),e("button",{staticClass:"close-modal",on:{click:function(e){t.showGenerateModal=!1}}},[t._v("×")])]),e("div",{staticClass:"modal-body"},[e("form",{on:{submit:function(e){return e.preventDefault(),t.generateReport.apply(null,arguments)}}},[e("div",{staticClass:"form-item"},[t._m(11),e("div",{staticClass:"form-input-group"},[e("i",{staticClass:"fa fa-tint input-icon"}),e("input",{directives:[{name:"model",rawName:"v-model",value:t.generateForm.sourceStrId,expression:"generateForm.sourceStrId"}],attrs:{type:"text",required:"",placeholder:"例：01KAR9BBFPNCV0KGVDHPQ941A7"},domProps:{value:t.generateForm.sourceStrId},on:{input:function(e){e.target.composing||t.$set(t.generateForm,"sourceStrId",e.target.value)}}})])])])]),e("div",{staticClass:"modal-footer"},[e("button",{staticClass:"btn cancel-btn",on:{click:function(e){t.showGenerateModal=!1}}},[t._v("取消")]),e("button",{staticClass:"btn primary-btn",attrs:{disabled:t.loading.generateReport},on:{click:t.generateReport}},[t._v(" "+t._s(t.loading.generateReport?"生成中...":"确认生成")+" ")])])])]):t._e(),t.showReportDetailModal?e("div",{staticClass:"modal"},[e("div",{staticClass:"modal-overlay",on:{click:function(e){t.showReportDetailModal=!1}}}),e("div",{staticClass:"modal-content",staticStyle:{"max-width":"800px"}},[e("div",{staticClass:"modal-header"},[t._m(12),e("button",{staticClass:"close-modal",on:{click:function(e){t.showReportDetailModal=!1}}},[t._v("×")])]),e("div",{staticClass:"modal-body"},[t.currentReportDetail?e("div",{staticClass:"report-detail-content"},[e("div",{staticClass:"detail-section"},[e("h4",[t._v("基本信息")]),e("div",{staticClass:"detail-grid"},[e("div",{staticClass:"detail-item"},[e("span",{staticClass:"detail-label"},[t._v("水源ID:")]),e("span",{staticClass:"detail-value"},[t._v(t._s(t.currentReportDetail.sourceStrId))])]),e("div",{staticClass:"detail-item"},[e("span",{staticClass:"detail-label"},[t._v("水源名称:")]),e("span",{staticClass:"detail-value"},[t._v(t._s(t.currentReportDetail.sourceName||"未知"))])]),e("div",{staticClass:"detail-item"},[e("span",{staticClass:"detail-label"},[t._v("水源类型:")]),e("span",{staticClass:"detail-value"},[t._v(t._s(t.currentReportDetail.sourceType||"未知"))])]),e("div",{staticClass:"detail-item"},[e("span",{staticClass:"detail-label"},[t._v("生成时间:")]),e("span",{staticClass:"detail-value"},[t._v(t._s(t.formatDateTime(t.currentReportDetail.generatedAt)))])]),e("div",{staticClass:"detail-item"},[e("span",{staticClass:"detail-label"},[t._v("发布状态:")]),e("span",{staticClass:"detail-value"},[t._v(t._s(t.currentReportDetail.isPublished?"已发布":"私有"))])]),t.currentReportDetail.keywords?e("div",{staticClass:"detail-item full-width"},[e("span",{staticClass:"detail-label"},[t._v("关键词:")]),e("span",{staticClass:"detail-value"},[t._v(t._s(t.currentReportDetail.keywords))])]):t._e()])]),t.currentReportDetail.usedData&&t.currentReportDetail.usedData.length>0?e("div",{staticClass:"detail-section"},[e("h4",[t._v("使用数据")]),e("div",{staticClass:"data-table"},[t._m(13),t._l(t.currentReportDetail.usedData,function(s){return e("div",{key:s.strId,staticClass:"table-row"},[e("div",{staticClass:"table-cell"},[t._v(t._s(s.strId))]),e("div",{staticClass:"table-cell"},[t._v(t._s(t.formatDateTime(s.measuredAt)))]),e("div",{staticClass:"table-cell"},[t._v(t._s(s.turbidityValue))]),e("div",{staticClass:"table-cell"},[t._v(t._s(s.unit))])])})],2)]):t._e(),e("div",{staticClass:"detail-section"},[e("h4",[t._v("报告内容")]),e("div",{staticClass:"formatted-report-content",domProps:{innerHTML:t._s(t.formatReportContent(t.currentReportDetail.reportContent))}})])]):e("div",{staticClass:"loading-state"},[e("i",{staticClass:"fa fa-spinner fa-spin loading-icon"}),e("p",[t._v("加载报告详情中...")])])]),e("div",{staticClass:"modal-footer"},[e("button",{staticClass:"btn primary-btn",on:{click:function(e){t.showReportDetailModal=!1}}},[t._v("关闭")])])])]):t._e(),t._m(14)],1)},ft=[function(){var t=this,e=t._self._c;return e("header",{staticClass:"system-header"},[e("div",{staticClass:"container"},[e("div",{staticClass:"header-right"})])])},function(){var t=this,e=t._self._c;return e("div",{staticClass:"header-content"},[e("div",{staticClass:"title-section"},[e("h1",{staticClass:"main-title"},[t._v("私有分析报告")]),e("p",{staticClass:"sub-title"},[t._v("管理您的水质分析报告")])])])},function(){var t=this,e=t._self._c;return e("div",{staticClass:"feature-icon"},[e("i",{staticClass:"fa fa-plus"})])},function(){var t=this,e=t._self._c;return e("div",{staticClass:"feature-content"},[e("h3",[t._v("生成新报告")]),e("p",[t._v("创建新的水质分析报告")])])},function(){var t=this,e=t._self._c;return e("div",{staticClass:"feature-arrow"},[e("i",{staticClass:"fa fa-arrow-right"})])},function(){var t=this,e=t._self._c;return e("div",{staticClass:"report-header"},[e("div",{staticClass:"report-title-section"},[e("h3",{staticClass:"report-title"},[t._v("水质分析报告")])])])},function(){var t=this,e=t._self._c;return e("div",{staticClass:"empty-icon-box"},[e("i",{staticClass:"fa fa-file-text-o empty-icon"})])},function(){var t=this,e=t._self._c;return e("h2",{staticClass:"panel-title"},[e("i",{staticClass:"fa fa-qrcode panel-icon"}),t._v(" 公开分析报告查询 ")])},function(){var t=this,e=t._self._c;return e("div",{staticClass:"empty-icon-box"},[e("i",{staticClass:"fa fa-file-o empty-icon"})])},function(){var t=this,e=t._self._c;return e("h3",[e("i",{staticClass:"fa fa-file-text-o"}),t._v(" 公开报告详情")])},function(){var t=this,e=t._self._c;return e("h3",{staticClass:"modal-title"},[e("i",{staticClass:"fa fa-file-text modal-icon"}),t._v(" 生成私有分析报告 ")])},function(){var t=this,e=t._self._c;return e("label",{staticClass:"form-label"},[t._v("水源ID "),e("span",{staticClass:"required"},[t._v("*")])])},function(){var t=this,e=t._self._c;return e("h3",{staticClass:"modal-title"},[e("i",{staticClass:"fa fa-file-text-o modal-icon"}),t._v(" 报告详情 ")])},function(){var t=this,e=t._self._c;return e("div",{staticClass:"table-header"},[e("div",{staticClass:"table-cell"},[t._v("数据ID")]),e("div",{staticClass:"table-cell"},[t._v("测量时间")]),e("div",{staticClass:"table-cell"},[t._v("浊度值")]),e("div",{staticClass:"table-cell"},[t._v("单位")])])},function(){var t=this,e=t._self._c;return e("footer",{staticClass:"system-footer"},[e("div",{staticClass:"container"},[e("p",{staticClass:"footer-text"},[t._v("© 2024 水质分析报告管理系统")])])])}],Ct=(s(1148),s(116),s(1701),{name:"ReportManagement",components:{MainHeader:b},data(){return{activeModule:"private-report",currentUser:{username:"管理员",id:"user_001"},privateReports:[],filteredReports:[],showGenerateModal:!1,generateForm:{sourceStrId:""},searchSourceId:"",searchLoading:!1,isSearching:!1,publicReportId:"",publicReportDetail:null,showReportDetailModal:!1,currentReportDetail:null,loading:{privateReports:!1,generateReport:!1,publicReport:!1,reportDetail:!1}}},mounted(){console.log("组件开始挂载，准备获取报告数据..."),this.fetchPrivateReports()},methods:{switchModule(t){this.activeModule=t,"private-report"===t?this.fetchPrivateReports():"public-report"===t&&(this.publicReportDetail=null,this.publicReportId="")},formatReportContent(t){if(!t||"string"!==typeof t)return'<div class="no-content">暂无详细报告内容</div>';let e=t.replace(/<think>[\s\S]*?<\/think>/gi,"");if(e=e.replace(/\n\s*\n\s*\n/g,"\n\n").trim(),!e.trim())return'<div class="no-content">暂无详细报告内容</div>';let s=e;s=s.replace(/^\*\* (.+?) \*\*/gm,'<h2 class="report-section-title">$1</h2>'),s=s.replace(/^### (.+?)$/gm,'<h3 class="report-subtitle">$1</h3>'),s=s.replace(/^- (.+?)$/gm,'<li class="report-list-item">$1</li>'),s.includes('<li class="report-list-item">')&&(s=s.replace(/(<li class="report-list-item">[\s\S]*?)<\/li>/g,'<ul class="report-list">$1</ul>')),s=s.replace(/\| (.+?) \|/g,(t,e)=>{const s=e.split("|").map(t=>t.trim());return s.length>1?s.every(t=>""===t.replace(/-/g,""))?"":`<tr class="report-table-row">${s.map(t=>`<td class="report-table-cell">${t}</td>`).join("")}</tr>`:t}),s.includes('<tr class="report-table-row">')&&(s=s.replace(/(<tr class="report-table-row">[\s\S]*?)<\/tr>/g,'<table class="report-table">$1</table>')),s=s.replace(/\*\*(.+?)\*\*/g,'<strong class="report-bold">$1</strong>'),s=s.replace(/^-{3,}$/gm,'<hr class="report-divider">');const a=s.split("\n");let r=!1,i="";for(let o=0;o<a.length;o++){const t=a[o].trim();t?t.startsWith("<h2")||t.startsWith("<h3")||t.startsWith("<ul")||t.startsWith("<table")||t.startsWith("<li")||t.startsWith("<hr")?(r&&(i+="</p>",r=!1),i+=t+"\n"):(r||(i+='<p class="report-paragraph">',r=!0),i+=t+" "):(r&&(i+="</p>",r=!1),i+="<br>")}return r&&(i+="</p>"),i||'<div class="no-content">暂无详细报告内容</div>'},filterReportContent(t){if(!t||"string"!==typeof t)return t||"";const e=/<think>[\s\S]*?<\/think>/gi;let s=t.replace(e,"");return s=s.replace(/\n\s*\n\s*\n/g,"\n\n").trim(),s},fetchPrivateReports(){this.loading.privateReports=!0,console.log("开始获取报告数据..."),$.A.get("/reports").then(t=>{console.log("API响应数据:",t.data),t.data&&Array.isArray(t.data)?(console.log("找到报告数据，数量:",t.data.length),this.privateReports=t.data.map(t=>({strId:t.strId,sourceStrId:t.sourceStrId,generatedAt:t.generatedAt,isPublished:t.isPublished,keywords:t.keywords,qrCodePath:t.qrCodePath,reportContent:this.filterReportContent(t.reportContent)})),this.filteredReports=[...this.privateReports],console.log("最终报告列表:",this.privateReports)):(console.log("没有报告数据"),this.privateReports=[],this.filteredReports=[])}).catch(t=>{console.error("获取报告列表失败:",t),this.showToast("获取报告列表失败","error"),this.privateReports=[],this.filteredReports=[]}).finally(()=>{this.loading.privateReports=!1,console.log("加载完成，报告数量:",this.privateReports.length)})},async handleSearchBySourceId(){if(this.searchSourceId.trim()){this.searchLoading=!0,this.isSearching=!0;try{const t=await $.A.get(`/reports/by-source/${this.searchSourceId.trim()}`);console.log("搜索响应:",t);let e=[];t.data&&Array.isArray(t.data)&&(e=t.data.map(t=>({strId:t.strId,sourceStrId:t.sourceStrId,generatedAt:t.generatedAt,isPublished:t.isPublished,keywords:t.keywords,qrCodePath:t.qrCodePath,reportContent:this.filterReportContent(t.reportContent)}))),e.length>0?(this.filteredReports=e,this.$message.success(`找到 ${e.length} 个报告`)):(this.filteredReports=[],this.$message.warning("未找到匹配的报告数据"),setTimeout(()=>{this.handleSearchClear()},1500))}catch(t){console.error("搜索错误:",t),this.filteredReports=[],t.response&&404===t.response.status?(this.$message.warning("该水源ID没有报告"),setTimeout(()=>{this.handleSearchClear()},1500)):this.$message.error("搜索失败")}finally{this.searchLoading=!1}}else this.$message.warning("请输入水源ID")},handleSearchClear(){this.isSearching=!1,this.searchSourceId="",this.searchLoading=!1,this.filteredReports=[...this.privateReports],this.$message.info("已清除搜索条件")},generateReport(){if(!this.generateForm.sourceStrId.trim())return void this.showToast("请输入水源ID！","error");this.loading.generateReport=!0;const t={sourceStrId:this.generateForm.sourceStrId};$.A.post("/reports/generate",t).then(t=>{if(t.data&&t.data.data){const e={strId:t.data.data.strId,sourceStrId:t.data.data.sourceStrId,generatedAt:t.data.data.generatedAt,isPublished:t.data.data.isPublished,keywords:t.data.data.keywords,qrCodePath:t.data.data.qrCodePath,reportContent:this.filterReportContent(t.data.data.reportContent),message:t.data.message||"报告生成成功"};this.privateReports.unshift(e),this.filteredReports=[...this.privateReports]}this.showToast("报告生成成功！","success"),this.showGenerateModal=!1,this.resetGenerateForm()}).catch(t=>{console.error("生成报告失败:",t),this.showToast(`生成报告失败: ${t.response?.data?.message||"服务器错误"}`,"error")}).finally(()=>{this.loading.generateReport=!1})},viewPrivateReport(t){this.loading.reportDetail=!0,this.showReportDetailModal=!0,this.currentReportDetail=null,$.A.get(`/reports/${t.strId}`).then(t=>{console.log("报告详情响应:",t.data),t.data&&(this.currentReportDetail={strId:t.data.strId,sourceStrId:t.data.sourceStrId,sourceName:t.data.sourceName,sourceType:t.data.sourceType,generatedAt:t.data.generatedAt,isPublished:t.data.isPublished,keywords:t.data.keywords,qrCodePath:t.data.qrCodePath,reportContent:this.filterReportContent(t.data.reportContent),difyMessageId:t.data.difyMessageId,usedData:t.data.usedData||[]})}).catch(t=>{console.error("获取报告详情失败:",t),this.$message.error("获取报告详情失败"),this.showReportDetailModal=!1}).finally(()=>{this.loading.reportDetail=!1})},togglePublishStatus(t){console.log(t.isPublished);const e=t.isPublished?"unpublish":"publish",s=t.isPublished?"取消发布":"发布",a=t.isPublished?`确定要将报告【${t.strId}】设为私有吗？\n设置后二维码将失效`:`确定要将报告【${t.strId}】发布为公开报告吗？\n发布后任何人可通过ID查询`;confirm(a)&&$.A.post(`/reports/${t.strId}/${e}`).then(()=>{t.isPublished=!t.isPublished,this.showToast(`报告${s}成功`,"success")}).catch(t=>{console.error(`${s}报告失败:`,t),this.showToast(`${s}报告失败`,"error")})},deleteReport(t){const e=this.privateReports.find(e=>e.strId===t);e&&confirm(`确定要删除报告【${e.strId}】吗？\n删除后不可恢复！`)&&$.A.delete(`/reports/${t}`).then(()=>{this.privateReports=this.privateReports.filter(e=>e.strId!==t),this.filteredReports=this.filteredReports.filter(e=>e.strId!==t),this.showToast("报告删除成功","success")}).catch(t=>{console.error("删除报告失败:",t),this.showToast("删除报告失败","error")})},queryPublicReport(){if(!this.publicReportId)return void this.showToast("请输入报告ID","warning");this.loading.publicReport=!0;const t=this.publicReportId;$.A.get(`http://47.92.234.121:8080/public/reports/${t}`).then(t=>{console.log("公开报告查询响应:",t),t.data?(this.publicReportDetail={strId:t.data.strId,sourceStrId:t.data.sourceStrId,sourceName:t.data.sourceName,sourceType:t.data.sourceType,generatedAt:t.data.generatedAt,isPublished:t.data.isPublished,keywords:t.data.keywords,qrCodePath:t.data.qrCodePath,reportContent:this.filterReportContent(t.data.reportContent),message:t.data.message},this.$message.success("查询成功"),console.log("公开报告详情:",this.publicReportDetail)):(this.publicReportDetail=null,this.$message.warning("未找到报告数据"))}).catch(t=>{if(console.error("查询公开报告失败:",t),t.response)switch(t.response.status){case 404:this.$message.error("报告未找到或未发布");break;case 500:this.$message.error("服务器内部错误");break;default:this.$message.error(`查询失败: ${t.response.data?.message||"未知错误"}`)}else this.$message.error("网络错误，请检查连接");this.publicReportDetail=null}).finally(()=>{this.loading.publicReport=!1})},validateGenerateForm(){return this.generateForm.sourceStrId.trim()},resetGenerateForm(){this.generateForm={sourceStrId:""}},formatDateTime(t){if(!t)return"";try{let e;if(Array.isArray(t)){const[s,a,r,i=0,o=0,l=0]=t;e=new Date(s,a-1,r,i,o,l)}else{if("string"!==typeof t)return console.warn("未知的日期时间格式:",t),String(t);e=new Date(t)}const s=e.getFullYear(),a=String(e.getMonth()+1).padStart(2,"0"),r=String(e.getDate()).padStart(2,"0"),i=String(e.getHours()).padStart(2,"0"),o=String(e.getMinutes()).padStart(2,"0"),l=String(e.getSeconds()).padStart(2,"0");return`${s}-${a}-${r} ${i}:${o}:${l}`}catch(e){return console.error("日期格式化错误:",e),Array.isArray(t)?t.join("-"):String(t)}},showToast(t,e="info"){const s={error:"错误",success:"成功",warning:"警告",info:"提示"};alert(`${s[e]||"提示"}：${t}`)},getQrCodeUrl(t){if(!t)return"";if(t.startsWith("http"))return t;const e="http://47.92.234.121:8080",s=e.endsWith("/")?e.slice(0,-1):e;let a=t;return a.startsWith("/")||(a="/"+a),`${s}${a}`},copyReportId(t){try{navigator.clipboard&&window.isSecureContext?navigator.clipboard.writeText(t).then(()=>{this.showToast("报告ID已复制到剪贴板","success")}).catch(e=>{console.error("复制失败:",e),this.fallbackCopyReportId(t)}):this.fallbackCopyReportId(t)}catch(e){console.error("复制报告ID时出错:",e),this.showToast("复制失败，请手动复制","error")}},fallbackCopyReportId(t){try{const s=document.createElement("textarea");s.value=t,s.style.position="fixed",s.style.left="-999999px",s.style.top="-999999px",document.body.appendChild(s),s.focus();try{window.getSelection?window.getSelection().removeAllRanges():document.selection&&document.selection.empty(),s.setSelectionRange(0,t.length);const e=document.execCommand("copy");e?this.showToast("报告ID已复制到剪贴板","success"):this.showToast("复制失败，请手动复制","error")}catch(e){console.error("文本选择时出错:",e),s.select();const t=document.execCommand("copy");t?this.showToast("报告ID已复制到剪贴板","success"):this.showToast("复制失败，请手动复制","error")}}catch(s){console.error("回退复制方法失败:",s),this.showToast("复制失败，请手动复制","error")}finally{const t=document.querySelector('textarea[style*="left: -999999px"]');t&&t.parentNode&&document.body.removeChild(t);try{document.activeElement.blur()}catch(a){}}}}}),bt=Ct,wt=(0,n.A)(bt,gt,ft,!1,null,"e1b43bf8",null),yt=wt.exports,_t=function(){var t=this,e=t._self._c;return e("div",{staticClass:"devices-container"},[e("MainHeader"),t._m(0),e("div",{staticClass:"devices-content"},[e("div",{staticClass:"function-area"},[e("el-button",{attrs:{type:"primary",loading:t.loading.unclaimed},on:{click:t.refreshUnclaimedDevices}},[e("i",{staticClass:"fa fa-refresh"}),t._v(" 刷新待绑定设备 ")]),e("el-button",{attrs:{type:"success"},on:{click:function(e){return t.openPairDialog()}}},[e("i",{staticClass:"fa fa-plus"}),t._v(" 手动绑定设备 ")])],1),e("div",{staticClass:"devices-section"},[t._m(1),t.loading.unclaimed?e("div",{staticClass:"loading-state"},[e("i",{staticClass:"fa fa-spinner fa-spin"}),t._v(" 加载中... ")]):0===t.unclaimedDevices.length?e("div",{staticClass:"empty-state"},[e("i",{staticClass:"fa fa-desktop empty-icon"}),e("p",[t._v("暂无待绑定设备")]),e("p",{staticClass:"empty-tip"},[t._v("请确保设备已开机并连接到网络")])]):e("div",{staticClass:"devices-grid"},t._l(t.unclaimedDevices,function(s){return e("div",{key:s.macAddress,staticClass:"device-card clickable-card",on:{click:function(e){return t.handleDeviceCardClick(s)}}},[e("div",{staticClass:"device-header"},[t._m(2,!0),e("el-tag",{attrs:{type:"info",size:"small"}},[t._v("待绑定")])],1),e("div",{staticClass:"device-info"},[e("div",{staticClass:"info-item"},[e("span",{staticClass:"label"},[t._v("MAC地址:")]),e("span",{staticClass:"value"},[t._v(t._s(s.macAddress))])]),e("div",{staticClass:"info-item"},[e("span",{staticClass:"label"},[t._v("最后在线:")]),e("span",{staticClass:"value"},[t._v(t._s(t.formatDateTime(s.lastSeen)))])])]),e("div",{staticClass:"device-actions"},[e("el-button",{attrs:{type:"primary",size:"small",loading:t.loading.pairing===s.macAddress},on:{click:function(e){return t.openPairDialog(s)}}},[e("i",{staticClass:"fa fa-link"}),t._v(" 绑定设备 ")])],1)])}),0)]),t._e()]),e("el-dialog",{attrs:{title:"绑定设备",visible:t.showPairDialog,width:"500px","close-on-click-modal":!1},on:{"update:visible":function(e){t.showPairDialog=e}}},[e("el-form",{ref:"pairForm",attrs:{model:t.pairForm,rules:t.pairRules,"label-width":"100px"}},[e("el-form-item",{attrs:{label:"MAC地址",prop:"macAddress"}},[e("el-input",{attrs:{placeholder:"请输入设备MAC地址",disabled:!!t.selectedDevice},model:{value:t.pairForm.macAddress,callback:function(e){t.$set(t.pairForm,"macAddress",e)},expression:"pairForm.macAddress"}},[e("template",{slot:"append"},[e("i",{staticClass:"fa fa-microchip"})])],2)],1),e("el-form-item",{attrs:{label:"水源ID",prop:"sourceStrId"}},[e("el-input",{attrs:{placeholder:"请输入水源ID"},model:{value:t.pairForm.sourceStrId,callback:function(e){t.$set(t.pairForm,"sourceStrId",e)},expression:"pairForm.sourceStrId"}},[e("template",{slot:"append"},[e("i",{staticClass:"fa fa-tint"})])],2)],1)],1),e("div",{staticClass:"dialog-footer",attrs:{slot:"footer"},slot:"footer"},[e("el-button",{on:{click:function(e){t.showPairDialog=!1}}},[t._v("取消")]),e("el-button",{attrs:{type:"primary",loading:t.loading.pairing},on:{click:t.pairDevice}},[t._v(" 确认绑定 ")])],1)],1)],1)},St=[function(){var t=this,e=t._self._c;return e("div",{staticClass:"header-section"},[e("h1",[t._v("设备联网管理")]),e("p",[t._v("管理已连接的监测设备和传感器")])])},function(){var t=this,e=t._self._c;return e("h3",[e("i",{staticClass:"fa fa-list"}),t._v(" 待绑定设备列表")])},function(){var t=this,e=t._self._c;return e("h4",[e("i",{staticClass:"fa fa-microchip"}),t._v(" 监测设备")])},function(){var t=this,e=t._self._c;return e("h3",[e("i",{staticClass:"fa fa-check-circle"}),t._v(" 已绑定设备")])}],It={name:"DevicesView",components:{MainHeader:b},data(){return{unclaimedDevices:[],showPairDialog:!1,selectedDevice:null,pairForm:{macAddress:"",sourceStrId:""},pairRules:{macAddress:[{required:!0,message:"请输入MAC地址",trigger:"blur"}],sourceStrId:[{required:!0,message:"请输入水源ID",trigger:"blur"}]},loading:{unclaimed:!1,pairing:!1}}},mounted(){this.refreshUnclaimedDevices()},methods:{async refreshUnclaimedDevices(){this.loading.unclaimed=!0;try{const t=await x.get("/devices/unclaimed");t.data?(this.unclaimedDevices=t.data,this.$message.success(`找到 ${this.unclaimedDevices.length} 个待绑定设备`)):(this.unclaimedDevices=[],this.$message.info("暂无待绑定设备"))}catch(t){console.error("获取待绑定设备失败:",t),this.$message.error("获取设备列表失败"),this.unclaimedDevices=[]}finally{this.loading.unclaimed=!1}},openPairDialog(t=null){this.selectedDevice=t;const e=localStorage.getItem("selectedWaterSourceId"),s=localStorage.getItem("selectedDeviceMacAddress");this.pairForm={macAddress:t?t.macAddress:s||"",sourceStrId:e||""},this.showPairDialog=!0,this.$nextTick(()=>{this.$refs.pairForm&&this.$refs.pairForm.clearValidate()}),this.pairForm.macAddress&&this.pairForm.sourceStrId&&this.$message.info('已自动填充水源ID和设备MAC地址，点击"确认绑定"完成绑定')},handleDeviceCardClick(t){localStorage.setItem("selectedDeviceMacAddress",t.macAddress),this.$message.success(`已选择设备: MAC地址 ${t.macAddress}`)},async pairDevice(){const t=await this.$refs.pairForm.validate().catch(()=>!1);if(t){this.loading.pairing=!0;try{const t={macAddress:this.pairForm.macAddress,sourceStrId:this.pairForm.sourceStrId},e=await x.post("/devices/pair",t);e.data&&e.data.message&&(this.$message.success(e.data.message||"设备绑定成功"),this.showPairDialog=!1,this.refreshUnclaimedDevices())}catch(e){console.error("绑定设备失败:",e);let t="绑定设备失败";if(e.response)switch(e.response.status){case 400:t="请求参数错误";break;case 404:t="设备或水源不存在";break;case 409:t="设备已被绑定";break;case 500:t="服务器内部错误";break;default:t=e.response.data?.message||"绑定失败"}this.$message.error(t)}finally{this.loading.pairing=!1}}},formatDateTime(t){if(!t)return"未知";try{const e=new Date(t);return e.toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"})}catch(e){return console.error("日期格式化错误:",e),t}}}},Rt=It,Dt=(0,n.A)(Rt,_t,St,!1,null,"1d9199ff",null),At=Dt.exports;a["default"].use(u.Ay);const $t=new u.Ay({mode:"history",routes:[{path:"/",name:"home",component:S},{path:"/auth",name:"auth",component:G},{path:"/water-sources",name:"waterSources",component:at,meta:{requiresAuth:!0}},{path:"/user-profile",name:"userProfile",component:ct,meta:{requiresAuth:!0}},{path:"/water-data",name:"UploadWaterData",component:vt,meta:{requiresAuth:!0}},{path:"/report",name:"Report",component:yt,meta:{requiresAuth:!0}},{path:"/devices",name:"devices",component:At,meta:{requiresAuth:!0}}]});$t.beforeEach((t,e,s)=>{const a=t.matched.some(t=>t.meta.requiresAuth),r=!!localStorage.getItem("token");a&&!r?s("/auth"):"/auth"===t.path&&r?s("/"):s()});var kt=$t;a["default"].use(T()),a["default"].config.productionTip=!1,new a["default"]({router:kt,render:t=>t(d)}).$mount("#app")},2675:function(t,e,s){t.exports=s.p+"img/OIP-C.3e400b9e.webp"},7163:function(t,e,s){t.exports=s.p+"img/R-C.5cbc35a2.jpg"},8163:function(t,e,s){t.exports=s.p+"img/1242484cK77.49135d5a.jpg"}},e={};function s(a){var r=e[a];if(void 0!==r)return r.exports;var i=e[a]={id:a,loaded:!1,exports:{}};return t[a].call(i.exports,i,i.exports,s),i.loaded=!0,i.exports}s.m=t,function(){s.amdO={}}(),function(){var t=[];s.O=function(e,a,r,i){if(!a){var o=1/0;for(d=0;d<t.length;d++){a=t[d][0],r=t[d][1],i=t[d][2];for(var l=!0,n=0;n<a.length;n++)(!1&i||o>=i)&&Object.keys(s.O).every(function(t){return s.O[t](a[n])})?a.splice(n--,1):(l=!1,i<o&&(o=i));if(l){t.splice(d--,1);var c=r();void 0!==c&&(e=c)}}return e}i=i||0;for(var d=t.length;d>0&&t[d-1][2]>i;d--)t[d]=t[d-1];t[d]=[a,r,i]}}(),function(){s.n=function(t){var e=t&&t.__esModule?function(){return t["default"]}:function(){return t};return s.d(e,{a:e}),e}}(),function(){s.d=function(t,e){for(var a in e)s.o(e,a)&&!s.o(t,a)&&Object.defineProperty(t,a,{enumerable:!0,get:e[a]})}}(),function(){s.g=function(){if("object"===typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(t){if("object"===typeof window)return window}}()}(),function(){s.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)}}(),function(){s.r=function(t){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}}(),function(){s.nmd=function(t){return t.paths=[],t.children||(t.children=[]),t}}(),function(){s.p="/"}(),function(){var t={524:0};s.O.j=function(e){return 0===t[e]};var e=function(e,a){var r,i,o=a[0],l=a[1],n=a[2],c=0;if(o.some(function(e){return 0!==t[e]})){for(r in l)s.o(l,r)&&(s.m[r]=l[r]);if(n)var d=n(s)}for(e&&e(a);c<o.length;c++)i=o[c],s.o(t,i)&&t[i]&&t[i][0](),t[i]=0;return s.O(d)},a=self["webpackChunkdeep_water2"]=self["webpackChunkdeep_water2"]||[];a.forEach(e.bind(null,0)),a.push=e.bind(null,a.push.bind(a))}();var a=s.O(void 0,[504],function(){return s(1605)});a=s.O(a)})();
//# sourceMappingURL=app.276e45cf.js.map